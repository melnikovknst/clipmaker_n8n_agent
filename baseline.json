{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 5
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -32,
        -240
      ],
      "id": "2cd440ff-cb72-474b-9d0f-62ffdfa8375e",
      "name": "Schedule Trigger",
      "disabled": true
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-1.5-pro",
          "mode": "list",
          "cachedResultName": "models/gemini-1.5-pro"
        },
        "messages": {
          "values": [
            {
              "content": "Ты ассистент по поиску видео YouTube. Твоя задача — готовить краткий поисковый запрос и чёткие фильтры под подкасты/длинные интервью/интересные видео. \nОтвечай строго валидным JSON по схеме:\n{\n  \"query\": \"string\",\n  \"filters\": {\n    \"language\": \"ru|en|any\",\n    \"min_duration_min\": number,\n    \"max_duration_min\": number,\n    \"exclude_shorts\": true,\n    \"must_not_contain\": [ \"shorts\", \"clips\", \"reaction\" ],\n    \"preferred_keywords\": [ \"подкаст\", \"интервью\" ],\n    \"published_within_days\": number\n  },\n  \"notes\": \"string\"\n}\nНе добавляй пояснений вне JSON.",
              "role": "model"
            },
            {
              "content": "Сформируй поисковый запрос для YouTube.  \nТребования:  \n- Подкасты или длинные интервью.  \n- Язык: русский.  \n- Длительность: от 40 до 180 минут.  \n- Новизна: не старше 365 дней.  \n- Исключить shorts, клипы, реакции.  \n- Тематика: бизнес, политика, экономика, социальные и культурные тренды.  \n- Должно быть интересно и цепляюще.  \n\nВерни только JSON."
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        208,
        0
      ],
      "id": "5417b777-ff3a-4b3d-9cad-9a7241b0d227",
      "name": "Message a model",
      "credentials": {
        "googlePalmApi": {
          "id": "ryxUzROF1QOUbNeK",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Парсим ответ Gemini независимо от структуры и обёртки ```json ... ```\nreturn items.map(({ json }) => {\n  // 1) Берём текст из разных возможных мест\n  let raw =\n    json?.content?.parts?.[0]?.text ??\n    json?.text ??\n    \"\";\n\n  // 2) Превращаем в строку и снимаем тройные кавычки/префикс \"json\"\n  raw = String(raw)\n    .trim()\n    .replace(/^```(?:json)?\\s*/i, \"\")   // убираем ```json или ```\n    .replace(/```$/i, \"\")               // закрывающие ```\n    .trim();\n\n  // 3) Пытаемся распарсить JSON\n  let obj;\n  try {\n    obj = JSON.parse(raw);\n  } catch (e) {\n    // Если вдруг модель прислала невалидный JSON — пробрасываем сырец для дебага\n    obj = { parse_error: String(e), raw_text: raw };\n  }\n\n  return { json: obj };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        0
      ],
      "id": "b09d0bdb-85df-4299-8744-b7ac99d8206f",
      "name": "Code"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/youtube/v3/search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "KEY"
            },
            {
              "name": "part",
              "value": "snippet"
            },
            {
              "name": "type",
              "value": "video"
            },
            {
              "name": "q",
              "value": "={{$json[\"query\"]}}"
            },
            {
              "name": "maxResults",
              "value": "10"
            },
            {
              "name": "order",
              "value": "relevance"
            },
            {
              "name": "relevanceLanguage",
              "value": "ru"
            },
            {
              "name": "regionCode",
              "value": "RU"
            },
            {
              "name": "publishedAfter",
              "value": "={{ new Date(Date.now() - ($json[\"filters\"][\"published_within_days\"]||365) * 24 * 3600 * 1000).toISOString() }}"
            },
            {
              "name": "videoDuration",
              "value": "long"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        768,
        0
      ],
      "id": "223bae83-32f4-4e74-a668-6798d52fd26e",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// Из HTTP Request\nconst res = items[0].json || {};\nconst list = Array.isArray(res.items) ? res.items : [];\n\n// стоп-слова для клипов/шортсов/нарезок\nconst banned = [\"shorts\",\"clip\",\"clips\",\"reaction\",\"нарезка\",\"фрагмент\",\"шорт\"];\n\nfunction isOk(snippet){\n  const t = (snippet?.title||\"\").toLowerCase();\n  const d = (snippet?.description||\"\").toLowerCase();\n  return !banned.some(k => t.includes(k) || d.includes(k));\n}\n\n// ключ для Redis — нормализуем тему запроса\nconst topic = (items[0].json.query || \"\").trim().toLowerCase();\n\nconst out = [];\nfor (const it of list) {\n  const id = it?.id?.videoId;\n  if (!id) continue;\n  if (!isOk(it.snippet)) continue;\n\n  out.push({\n    json: {\n      topic,\n      videoId: id,\n      url: `https://www.youtube.com/watch?v=${id}`,\n      title: it.snippet?.title || \"\",\n      channel: it.snippet?.channelTitle || \"\",\n      publishedAt: it.snippet?.publishedAt || \"\",\n      description: it.snippet?.description || \"\",\n      thumb: it.snippet?.thumbnails?.high?.url || it.snippet?.thumbnails?.medium?.url || \"\"\n    }\n  });\n}\n\nif (!out.length) {\n  return [{ json: { error: \"no_candidates_after_filter\" } }];\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        0
      ],
      "id": "8228a059-e9e2-4945-a118-bfe169a9fa8c",
      "name": "Code1"
    },
    {
      "parameters": {
        "content": "Формирование json запроса для поиска видео",
        "height": 80,
        "width": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        224,
        -112
      ],
      "id": "c6b94a7b-aeec-455c-931c-86ba45677713",
      "name": "Sticky Note",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -48,
        0
      ],
      "id": "216be60e-f5c6-46dd-ad2c-2918289b6f04",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ \"seen:\" + $json.videoId }}",
        "value": "1"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2192,
        -128
      ],
      "id": "fbb7cbd6-8db7-431a-ba68-f7a9498d8fbc",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "e9BRyzVkU9IkE1iz",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1344,
        0
      ],
      "id": "7a4f0749-dc49-4cc3-994a-c3de17264ea1",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "content": "запрос видосов с yt\n",
        "height": 80,
        "width": 192
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        640,
        -96
      ],
      "id": "e80c030b-7040-4e27-be81-9ef2c6610852",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "                                      Валидация видосов",
        "height": 80,
        "width": 1008
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        944,
        -272
      ],
      "id": "79aea06f-6dc7-468b-9fbe-635764cecbd4",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "Валидный видос заносим в базу отработанных",
        "height": 80,
        "width": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2144,
        -208
      ],
      "id": "5952ba5e-156d-4f69-a635-71e8d8f45224",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "продолжай отсюда. тут тебе доступно videoID и url",
        "height": 80,
        "width": 256,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2400,
        96
      ],
      "id": "23c0ff6b-f70f-4d8a-aeee-36eecdf207e0",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "       тупик",
        "height": 80,
        "width": 150
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2320,
        -112
      ],
      "id": "d19c7f16-8bad-459e-a714-f70d0e76c744",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## ДРОП БАЗЫ\n",
        "height": 80,
        "width": 176,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1648,
        416
      ],
      "id": "660b2da6-1615-4d0d-8487-6ec1023524fd",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f3856e02-67d5-4cf5-b325-ee7568a5fbfc",
              "name": "videoId",
              "value": "={{ $json.videoId }}",
              "type": "string"
            },
            {
              "id": "b4f416c0-b6a7-4d30-83bf-17b0e980be4f",
              "name": "url",
              "value": "={{ $json.url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2192,
        80
      ],
      "id": "130bdb8c-07ca-4b18-8a7d-43008160b3c0",
      "name": "drop isSeen flag"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7ef7217-6e23-41df-bbf5-3b27ef919a2d",
              "leftValue": "={{ $json.isSeen }}",
              "rightValue": "=",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1904,
        80
      ],
      "id": "33f937dc-51db-4fcf-bab5-6960f86c31c0",
      "name": "isSeen"
    },
    {
      "parameters": {
        "mode": "combineBySql",
        "query": "SELECT * FROM input2 LEFT JOIN input1 ON input2.name = input1.id",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1696,
        112
      ],
      "id": "f3400561-40ad-485a-a865-7a66ff0cd7da",
      "name": "add isSeen flag",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08c9053d-9abb-4fc6-ae61-20c100ecb296",
              "name": "videoId",
              "value": "={{ $json.videoId }}",
              "type": "string"
            },
            {
              "id": "370b9f65-5347-40ea-97b7-0e487102d685",
              "name": "url",
              "value": "={{ $json.url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1136,
        0
      ],
      "id": "48feaa04-1334-4823-af10-c9cfc3c0a544",
      "name": "drop useless fields"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1744,
        528
      ],
      "id": "c94d4a3d-d414-41ba-8dcb-d512479f80cb",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst keys = (item.json.keys || []);\n\n// Возвращаем по одному item на ключ\nreturn keys.map(k => ({ json: { key: k } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1552,
        528
      ],
      "id": "4cecf75f-8fd2-404f-98a0-f65dddbdc59d",
      "name": "split keys"
    },
    {
      "parameters": {
        "operation": "keys",
        "keyPattern": "seen:*",
        "getValues": false
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1408,
        528
      ],
      "id": "74f54ffb-7e71-4763-a098-7ea68557bcf6",
      "name": "get all keys",
      "credentials": {
        "redis": {
          "id": "e9BRyzVkU9IkE1iz",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $json.key }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1904,
        624
      ],
      "id": "f3bf02d9-de89-4916-b3da-9377fdfc321f",
      "name": "del key",
      "credentials": {
        "redis": {
          "id": "e9BRyzVkU9IkE1iz",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "keys",
        "keyPattern": "seen:*"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2016,
        480
      ],
      "id": "7cd080bc-4236-42f0-87ae-74d11dbc8181",
      "name": "get all keys (check)",
      "credentials": {
        "redis": {
          "id": "e9BRyzVkU9IkE1iz",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "isSeen",
        "key": "={{ \"seen:\" + $json.videoId }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1600,
        -96
      ],
      "id": "1a102fb2-7104-487e-b188-5676ea157c98",
      "name": "isSeen request",
      "credentials": {
        "redis": {
          "id": "e9BRyzVkU9IkE1iz",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "resource": "video",
        "filters": {
          "q": ""
        },
        "options": {}
      },
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [
        752,
        336
      ],
      "id": "208b45d6-753d-4a31-8fb9-1795efb724b6",
      "name": "Get many videos"
    },
    {
      "parameters": {
        "content": "## Брат\nЗамени на нормальный ЮТ блок. Правильнее и безопаснее (апи ключ в \nсохранности будет)",
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        688,
        192
      ],
      "id": "eaa2b556-68a2-490e-8131-59dd65ee326e",
      "name": "Sticky Note1"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        []
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "drop useless fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "isSeen request",
            "type": "main",
            "index": 0
          },
          {
            "node": "add isSeen flag",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "isSeen": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          },
          {
            "node": "drop isSeen flag",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "add isSeen flag": {
      "main": [
        [
          {
            "node": "isSeen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "drop useless fields": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "get all keys (check)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "del key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "split keys": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get all keys": {
      "main": [
        [
          {
            "node": "split keys",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "del key": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "isSeen request": {
      "main": [
        [
          {
            "node": "add isSeen flag",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f7a6f9f8-2720-4485-923a-7df664c69609",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c6edc769acbcaf6a9fec4effe84de8dc0c3271b444bd76cb911596e0007b3f0d"
  },
  "id": "0EkO6PMAwX12pbAc",
  "tags": []
}
